(()=>{const e=e=>"V"===e,t={1027:"Sponsored Display DRA"},i={1:"Enabled",0:"NotEnabled","-1":"Unknown"},a=e=>s(e),s=e=>decodeURIComponent(escape(atob(e))),n=e=>e&&0===Object.keys(e).length&&e.constructor===Object,r="adfetch_request",o="adfetch_punt",d="adfetch_error",l="adfetch_noad",c="adfetch_renderad",h="adfetch_rendererror",m="adfetch_httperror",u="sfImpression",v="LightAdImpression",p="viewablelatency",w=(e,t,i)=>({csaKey:e,csmKey:t,csmMessage:i}),g=(w("bodyBegin","bb",u),w("bodyBegin","bb",v),w("bodyEnd","be")),f=(w("clickToATF","af"),w("criticalFeature","cf"),w("criticalFeature","cf",u),w("criticalFeature","cf",v),w("loaded","ld")),b=w("loaded","ld",u),y=(w("loaded","ld",v),w("viewablelatency:bodyBegin","bb",p),w("viewablelatency:loaded","ld",p),"adload_renderstart"),C="adload_renderend",E="viewability",M="unservedviewability",x="adload:renderstart",P="adload:renderend",I="adload:viewability",S="adload:unservedviewability",A=async(e,t,i,a,s)=>{const n={callBackReceived:!0,errFallback:e.handleFallbackBehavior.name};if(i&&0!==Object.keys(i).length){switch(n.adContent=i,n.status=i.status,i.status){case"punt":e.countMetric(o,1),e.logCsaEvent(o),a.aaxInstrPixelUrl=i.instrPixelURL,q(e,a,t),n.aaxReturnedPunt=!0;break;case"error":e.countMetric(d,1),e.logCsaEvent(d),e.handleFallbackBehavior(),n.aaxReturnedError=!0;break;default:try{a.aaxImpPixelUrl=i.impPixelURL,a.aaxInstrPixelUrl=i.instrPixelURL,a.htmlContent=i.creative,a.measurementHtml=null==i?void 0:i.aaxMeasurementTrackers.html,a.adFeedbackInfo&&(a.adFeedbackInfo.adProgramId=`${i.programId}`),a.adCreativeMetaData&&(a.adCreativeMetaData.adProgramId=`${i.programId}`,a.adCreativeMetaData.adImpressionId=i.impPixelURL,"null"!==(null==i?void 0:i.creativeIdStr)&&(a.adCreativeMetaData.adCreativeId=i.creativeIdStr),a.adCreativeMetaData.adCreativeTemplateName=i.creativeTemplateName,"null"!==(null==i?void 0:i.adIdStr)&&(a.adCreativeMetaData.adId=i.adIdStr)),n.aaxReturnedContent=!0,e.sendAdBarTrace("aaxCall",n),await s(a.htmlContent,a.measurementHtml),e.countMetric(c,1),e.logCsaEvent(c)}catch(r){e.logError("Faiure",r),e.handleFallbackBehavior(),e.countMetric(h,1),e.logCsaEvent(h),n.error="renderError"}}window.adReporterConfig&&t.sendMessage("saveAdDetailsForAdReporter",a)}else e.countMetric(l,1),e.logCsaEvent(l),e.handleFallbackBehavior(),n.error="emptyAAXResponse";e.sendAdBarTrace("aaxCall",n)},T=e=>e?e.toLowerCase().replace(/[^0-9a-z]/g,""):"unknown",F=(e,t,i)=>{if(t&&t.adCreativeMetaData&&0!==Object.keys(t.adCreativeMetaData).length){const a=T(t.adCreativeMetaData.adCreativeTemplateName);e.addCsmTag("adrender"),e.addCsmTag("adrender:safeframe"),e.addCsmTag("adrender","creativetemplatename:"+a),i.sendMessage("addCsaEntity",{adrender:"true",creativeTemplateName:a,isLightAds:"false"}),t.adCreativeMetaData.adCreativeId&&(e.addCsmTag("adrender","creativeid:"+t.adCreativeMetaData.adCreativeId),i.sendMessage("addCsaEntity",{creativeId:t.adCreativeMetaData.adCreativeId.toString()})),t.adCreativeMetaData.adProgramId&&(e.addCsmTag("adrender","programid:"+t.adCreativeMetaData.adProgramId),i.sendMessage("addCsaEntity",{adProgramId:t.adCreativeMetaData.adProgramId.toString()})),void 0!==t.isCardsFlow&&i.sendMessage("addCsaEntity",{isCardsFlow:t.isCardsFlow.toString()})}else e.addCsmTag("noadrender"),i.sendMessage("addCsaEntity",{adrender:"false"})},L=async(e,t,i)=>{i.countMetric(x,1),i.logCsaEvent(y),i.sendAdBarTrace("renderHtmlContentStart",{readyState:document.readyState});const a=H();if(t.renderCompleteTime&&"complete"!==document.readyState&&null!==document.currentScript){let t=document.currentScript;for(t.insertAdjacentHTML("afterend",e),t=t.nextElementSibling;null!==t;)"SCRIPT"===t.tagName?B(t):O(t),t=t.nextElementSibling}else V(e),N(),O(document.documentElement);t.ensureGlobals(),await a,await async function(){const e=document.querySelectorAll("img"),t=Array.from(e).filter(W).map((e=>new Promise((t=>{e.addEventListener("load",(()=>{t()}),{once:!0})}))));await Promise.all(t)}(),t.renderCompleteTime=new Date,window.addEventListener("load",(()=>{t.isLdFired||(t.isLdFired=!0,i.sendLatencyMetric(f))})),window.addEventListener("load",i.fireViewableLatencyMetrics),i.countMetric(P,1),i.logCsaEvent(C),i.sendAdBarTrace("renderHtmlContentEnd",{readyState:document.readyState})},_="creativeReplayStatus",D="iscomplete",k="creativeReplayComplete",R=`document.dispatchEvent(new CustomEvent("${k}"));`,N=()=>{document.body.innerHTML+=`<script id="${_}">${R}<\/script>`},U=e=>{var t;return null===(t=document.getElementById(_))||void 0===t?void 0:t.setAttribute(e,"true")},H=()=>new Promise(((e,t)=>{const i=document.getElementById(_);if("true"===(null==i?void 0:i.getAttribute(D)))e();else{document.addEventListener(k,(()=>{U(D),e()}),{once:!0});const a=5e3;setTimeout((()=>{"true"!==(null==i?void 0:i.getAttribute(D))&&t(new Error(`Creative script replay not detected within ${a} timeout`))}),a)}})),B=e=>{var t,i;const a=document.createRange();a.selectNode(e);const s=a.createContextualFragment(e.outerHTML).firstElementChild;if(s.getAttribute("src"))s.async=!1;else{const t=e.innerHTML;s.async=!1,s.setAttribute("src",`data:text/javascript;charset=UTF-8,${encodeURIComponent(t)}`)}null===(t=e.parentNode)||void 0===t||t.insertBefore(s,e.nextSibling),null===(i=e.parentNode)||void 0===i||i.removeChild(e)},V=e=>{if(null==document.documentElement){const e=document.createElement("html");document.appendChild(e)}document.documentElement.innerHTML=e},O=e=>{const t=e.querySelectorAll("script");for(const i of t)B(i)},W=e=>{!e.complete||(e=>e.naturalWidth>0||e.naturalHeight>0)(e)||(e=>{0===e.height||e.width})(e)};const $="cod_client",z=async(e,t)=>{await new Promise((i=>document.addEventListener("loadAdWithRelocatedHtmlContent",(async s=>{await(async i=>{const s=a(i.detail.htmlContentEncoded),n=a(t||"");await e(s,n)})(s),i()}),{once:!0})))},j=()=>{try{Object&&Object.defineProperty&&"function"==typeof Object.defineProperty?Object.defineProperty(document,"cookie",{get:function(){return""},set:function(){}}):(document.__defineGetter__("cookie",(function(){return""})),document.__defineSetter__("cookie",(function(){})))}catch(e){}},q=(e,t,i)=>{t.isNoInventory=!0,F(e,t,i),i.sendMessage("startPixelTracking",{measurementMethod:$,isNoInventory:t.isNoInventory})},G=e=>{var t;return null!==(t=null==e?void 0:e.replace(/^http:/,"https:"))&&void 0!==t?t:e},X=(e,t)=>{console.error(e,t)};let K=null,J=null,Q=null,Y=null,Z=null;const ee=new class{viewabilityStandards(){return Y=Y||[],Y}payload(){return Q=Q||{},Q}},te={ext:{inViewPercentage:()=>(K=K||0,Math.round(100*K)),geom:()=>(J=J||{},J)}},ie={playingTime:()=>(Z=Z||0,Z)},ae=()=>ee,se=()=>ie,ne=e=>{var t,i,a,s;K=void 0!==(null===(i=null===(t=null==e?void 0:e.geom)||void 0===t?void 0:t.self)||void 0===i?void 0:i.iv)?null===(s=null===(a=null==e?void 0:e.geom)||void 0===a?void 0:a.self)||void 0===s?void 0:s.iv:null,null===K&&delete te.ext.inViewPercentage,J=void 0!==(null==e?void 0:e.geom)?null==e?void 0:e.geom:null,null===J&&delete te.ext.geom,Q=void 0!==(null==e?void 0:e.payload)?null==e?void 0:e.payload:null,null===Q&&delete ee.payload,Y=void 0!==(null==e?void 0:e.viewabilityStandards)?null==e?void 0:e.viewabilityStandards:null,null===Y&&delete ee.viewabilityStandards};var re=function(e,t,i){if(""===t)throw new Error("Invalid queryParamKey input to addJSONQueryParamToURL: "+JSON.stringify({queryParamKey:t}));var a=new URL(e),s=a.searchParams.get(t),n=s||"{}",r=JSON.parse(n),o=Object.assign(r,i);return a.searchParams.set(t,JSON.stringify(o)),a.toString()};const oe=(e,t,i)=>{let a=e+t;return i&&(a+="_"+i),a},de=async(e,{pixelUrl:t,id:i,baseCounterName:a,baseMetricName:s,counterExtension:n},r)=>{try{return!(e=>!!document.getElementById(e))(i)&&(e.logCsaEvent(oe(s,"fired",n)),e.countMetric(oe(a,"fired",n),1),e.sendAdBarTrace("pixels",{fired:{pixelUrl:t,additionalTrace:r}}),await fetch(t,{keepalive:!0,mode:"no-cors"}),document.getElementsByTagName("body")[0].appendChild(((e,t)=>{const i=document.createElement("img");return i.id=e,i.style.display="none",i.setAttribute("pixel-url",t),i})(i,t)),e.countMetric(oe(a,"loaded",n),1),e.logCsaEvent(oe(s,"loaded",n)),e.sendAdBarTrace("pixels",{loaded:{pixelUrl:t,additionalTrace:r}}),!0)}catch(o){throw e.countMetric(oe(a,"error",n),1),e.logCsaEvent(oe(s,"error",n)),e.sendAdBarTrace("pixels",{error:{pixelUrl:t,additionalTrace:r}}),e.logError(`Error firing pixels: ${t}`,o),o}},le=(e,t,i)=>e+t+JSON.stringify(i),ce="impressionFired",he="btr:impression",me="viewable",ue="not_viewable";class ve{constructor(){this._viewableStartTimeInMilliseconds=void 0,this._currentState=ue,this._isCurrentlyInNotViewableState=()=>this._currentState===ue,this.transitionToViewableState=e=>{this._isCurrentlyInNotViewableState()&&(this._viewableStartTimeInMilliseconds=e),this._currentState=me},this.transitionToNotViewableState=()=>{this._currentState=ue},this.getViewableTimeInSeconds=e=>this._isCurrentlyInNotViewableState()||void 0===this._viewableStartTimeInMilliseconds?0:(e-this._viewableStartTimeInMilliseconds)/1e3}}var pe=function(e){return e.complete&&e.naturalHeight>0&&e.naturalWidth>0},we=function(e){return 1===e.naturalHeight&&1===e.naturalWidth},ge=function(e){var t=e.getElementsByClassName("mrc-btr-creative"),i=t.length>0;if(i){var a=function(e){for(var t=[],i=0,a=0,s=0;s<e.length;s++){var n=e[s];n instanceof HTMLImageElement&&(pe(n)?(t.push({src:n.src,isLoaded:!0}),a++):(t.push({src:n.src,isLoaded:!1}),i++))}return{isBTRCompliant:a>0&&0===i,imagesData:t}}(t);return{isBTRTaggedCreative:i,isBTRCompliant:a.isBTRCompliant,imagesData:a.imagesData}}var s=function(e){for(var t=[],i=0,a=0,s=0;s<e.length;s++){var n=e[s];n instanceof HTMLImageElement&&(pe(n)?we(n)||(t.push({src:n.src,isLoaded:!0}),i++):(t.push({src:n.src,isLoaded:!1}),a++))}return{isBTRCompliant:i>0&&0===a,imagesData:t}}(e.getElementsByTagName("img"));return{isBTRTaggedCreative:i,isBTRCompliant:s.isBTRCompliant,imagesData:s.imagesData}};const fe=e=>"Image"===e||"Image - mobile O&O"===e,be=async e=>{const t=await fetch(e,{keepalive:!0});if(t.ok)return await t.json();throw new Error(`Failed to fetch ad from ${e} due to ${t.status}`)};class ye{constructor(e,t,i){this.c=e,this.o=t,this.cms=i,this.viewedPixels={},this._viewableTimeCalculators={},this.hasLoaded=!1,this.fireImageLoaded=e=>{var t,i;if(!this.hasLoaded&&fe(e)){const e=null===(t=document.getElementsByClassName("ad-background-image"))||void 0===t?void 0:t[0];if(e&&"IMG"===e.tagName)if(e.complete)this.c.countMetric("imageLoaded",1,!0),this.c.countMetric("imageLoaded:adid:"+this.o.adCreativeMetaData.adId,1,!0),this.hasLoaded=!0;else{const t=null===(i=e.onload)||void 0===i?void 0:i.bind(window);e.onload=e=>{t&&t(e),this.c.countMetric("imageLoaded",1,!0),this.c.countMetric("imageLoaded:adid:"+this.o.adCreativeMetaData.adId,1,!0),this.hasLoaded=!0}}}},this.fireImpressionPixel=async(e,t)=>{if(t)await de(this.c,{id:"ape_ni_impression",pixelUrl:le(this.o.aaxInstrPixelUrl,"nii/",{ni:!0}),baseCounterName:"adload:unservedimpression",baseMetricName:"unservedimpression"});else{const t=this.o.adCreativeMetaData.adProgramId?this.o.adCreativeMetaData.adProgramId:"unknown",i=this.o.adCreativeMetaData.adCreativeTemplateName,a=T(i),s=this.o.adCreativeMetaData.adId;let n=!1;const r=Ee(this.o.aaxImpPixelUrl,e);n="btr_client"===e;await de(this.c,{id:"ape_impression",pixelUrl:r,baseCounterName:"adload:impression",baseMetricName:"impression"})&&(this.c.countMetric(ce,1,!0),this.c.countMetric(ce+":program:"+t,1,!0),this.c.countMetric(ce+":template:"+a,1,!0),n&&(this.c.countMetric(he,1,!1),this.c.countMetric(he,1,!0),this.c.countMetric(he+":program:"+t,1,!0),this.c.countMetric(he+":template:"+a,1,!0)),fe(i)&&this.c.countMetric(ce+":adid:"+s,1,!0))}},this.fireMeasurabilityPixel=e=>{if(n(this.o)||n(this.c)||!this.o.aaxInstrPixelUrl)return;const t="ape_measurability";this.viewedPixels[t]||(de(this.c,{id:t,pixelUrl:le(this.o.aaxInstrPixelUrl,"atf/",{atf:e.atf}),baseCounterName:"adload:measurability",baseMetricName:"measurability"}),this.viewedPixels[t]={})},this.fireViewablePixelsForVideo=(e,t,i,a,s)=>{if(n(this.o)||n(this.c)||!this.o.aaxInstrPixelUrl||!i)return;const r=i=>{var s,n;t.v=i;const r=null===(s=this.o.computed)||void 0===s?void 0:s.aPageStart,o=null===(n=this.o.computed)||void 0===n?void 0:n.adStartTime;t.ptv=r?(Date.now()-r)/1e3:0,t.ttv=o?(Date.now()-o)/1e3:0,a&&(t.niv=!0);const d={viewableInfo:t,aaxInstrPixelUrl:this.o.aaxInstrPixelUrl,viewablePercentage:e};let l;a?(l=le(this.o.aaxInstrPixelUrl,"niv/",t),de(this.c,{id:"ape_ni_viewability_"+i.def,pixelUrl:l,baseCounterName:S,baseMetricName:M,counterExtension:i.def},d)):(l=le(this.o.aaxInstrPixelUrl,"v/",t),de(this.c,{id:"ape_viewability_"+i.def,pixelUrl:l,baseCounterName:I,baseMetricName:E,counterExtension:i.def},d))},o=(e,t)=>{const i=e.def;t&&Ce(t,e.p)?this._viewableTimeCalculators[i].transitionToViewableState(Date.now()):this._viewableTimeCalculators[i].transitionToNotViewableState();const a=this._viewableTimeCalculators[i].getViewableTimeInSeconds(Date.now()),n=!this.viewedPixels[i].viewed&&((e,t,i)=>{const a=e>=i.t,s=t&&t>=i.t;return a&&s})(a,s,e);n&&(this.viewedPixels[i].viewed=!0,r(e))};for(let n=0;n<i.length;n++){const e=i[n].def;e&&(this.viewedPixels[e]=this.viewedPixels[e]||{},this.viewedPixels[e].viewed=void 0!==this.viewedPixels[e].viewed&&this.viewedPixels[e].viewed,void 0===this._viewableTimeCalculators[e]&&(this._viewableTimeCalculators[e]=new ve))}for(let n=0;n<i.length;n++)o(i[n],e)},this.fireViewablePixels=(e,t,i,a)=>{var s;const n=i=>{var s,n;t.v=i;const r=null===(s=this.o.computed)||void 0===s?void 0:s.aPageStart,o=null===(n=this.o.computed)||void 0===n?void 0:n.adStartTime;t.ptv=r?(Date.now()-r)/1e3:0,t.ttv=o?(Date.now()-o)/1e3:0,a&&(t.niv=!0);const d={viewableInfo:t,aaxInstrPixelUrl:this.o.aaxInstrPixelUrl,viewablePercentage:e};let l;a?(l=le(this.o.aaxInstrPixelUrl,"niv/",t),de(this.c,{id:"ape_ni_viewability_"+i.def,pixelUrl:l,baseCounterName:S,baseMetricName:M,counterExtension:i.def},d)):(l=le(this.o.aaxInstrPixelUrl,"v/",t),de(this.c,{id:"ape_viewability_"+i.def,pixelUrl:l,baseCounterName:I,baseMetricName:E,counterExtension:i.def},d))},r=t=>{const i=t.p,a=t.t,s=t.def;!this.viewedPixels[s].viewed&&e&&Ce(e,i)?this.viewedPixels[s].timeout||(this.viewedPixels[s].timeout=setTimeout((()=>{this.viewedPixels[s].viewed=!0,n(t)}),1e3*a)):this.viewedPixels[s].timeout&&(clearTimeout(this.viewedPixels[s].timeout),this.viewedPixels[s].timeout=null)};for(const o of i){const e=o.def;(null===(s=this.viewedPixels)||void 0===s?void 0:s[e])||(this.viewedPixels[e]={viewed:!1,timeout:null}),r(o)}}}}const Ce=(e,t)=>100*e>=t&&0!==t||100*e>t&&0===t,Ee=(e,t)=>re(e,"pj",{measurementMethod:t}),Me=()=>{var e;return(document,e=document.body,ge(e)).isBTRCompliant?"btr_client":"cod_client"},xe=async e=>{if(e.includes("mrc-btr-creative")){if("btr_client"===Me())return Promise.resolve("btr_client");const e=new Promise((e=>{const t=new MutationObserver(((t,i)=>{for(const a of t){const t=a.target;(null==t?void 0:t.complete)&&(null==t?void 0:t.naturalHeight)>0&&(null==t?void 0:t.naturalWidth)>0&&(i.disconnect(),e())}}));t.observe(document.body,{subtree:!0,childList:!0,attributeFilter:["complete","naturalWidth","naturalHeight"]}),setTimeout((()=>{e(),t.disconnect()}),50)}));return await e,Promise.resolve(Me())}return Promise.resolve(Me())};class Pe{constructor(e,t){this.weblabsWindow=e,this.prefix=t,this.isT1=()=>"t1"===this.weblabTreatment(),this.isC=()=>"c"===this.weblabTreatment(),this.weblabTreatment=()=>{var e,t,i;return null===(i=null===(t=null===(e=this.weblabsWindow)||void 0===e?void 0:e.renderingWeblabs)||void 0===t?void 0:t[this.prefix])||void 0===i?void 0:i.toLowerCase()}}}const Ie=()=>new Pe(window,"ADPT_SF_DEALS_REFACTOR_820101"),Se=e=>["mobile-auto-top-advertising-0","auto-top-advertising-0"].includes(e)&&new Pe(window,"ADPT_SF_SPARKLE_838607").isT1();class Ae{constructor(t,i,a,s){this.cms=t,this.o=i,this.mL=a,this.renderFallbackExperience=s,this.expandAdSlot=e=>{this.cms.sendMessage("expandAdSlot",e)},this.expandAdSlotWithOverlap=e=>{this.cms.sendMessage("expandAdSlotWithOverlap",e)},this.resetSlotSize=()=>{this.cms.sendMessage("resetSlotSize")},this.fireImpression=async e=>{this.sendLatencyMetric(b),await this.cr.fireImpressionPixel(e.measurementMethod,e.isNoInventory),this.cms.sendMessage("clearCODFallback")},this.sendAdBarTrace=(e,t)=>{this.cms.sendMessage("sendAdBarTrace",{field:e,traceInfo:t})},this.changeSize=(e,t)=>{this.cms.sendMessage("changeSize",{width:e,height:t})},this.logCsaEvent=e=>{this.cms.sendMessage("logCsaEvent",{metricName:e})},this.addCsaEntity=e=>{this.cms.sendMessage("addEntity",e)},this.registerCustomMessageListener=(e,t)=>{this.mL[e]=t},this.sendLatencyMetric=e=>{this.cms.sendMessage("sendLatencyMetric",{latencyMetricType:e,timestamp:new Date})},this.countMetric=(e,t,i)=>{this.cms.sendMessage("countMetric",{metricMsg:e,value:t,isGlobal:!!i})},this.addCsmTag=(e,t,i)=>{this.cms.sendMessage("addCsmTag",{tag:e,msg:t,isGlobal:i})},this.fireViewableLatencyMetrics=()=>{this.cms.sendMessage("fireViewableLatencyMetrics",{adLoadedTimestamp:Date.now()})},this.feedbackLabelRendered=()=>{this.cms.sendMessage("feedbackLabelRendered")},this.feedbackOpenModal=()=>{this.cms.sendMessage("feedbackOpenModal")},this.customMessage=(e,t)=>{this.cms.sendMessage("customMessage",{key:e,body:t})},this.updateViewability=t=>{var i,a,s,n,r;const o=ae();if(ne(t),!this.o.aaxInstrPixelUrl||!o.payload||!o.viewabilityStandards)return;this.o.isNoInventory||void 0===t.atf||this.cr.fireMeasurabilityPixel(t);const d=(null===(a=null===(i=null===window||void 0===window?void 0:window.$sf)||void 0===i?void 0:i.ext)||void 0===a?void 0:a.geom)&&(null===(s=null===window||void 0===window?void 0:window.$sf)||void 0===s?void 0:s.ext.geom()),l=(null===(n=null==d?void 0:d.self)||void 0===n?void 0:n.iv)?null===(r=null==d?void 0:d.self)||void 0===r?void 0:r.iv:null;if(e(this.o.mediaType)){const e=se();this.cr.fireViewablePixelsForVideo(l,o.payload(),o.viewabilityStandards(),!!this.o.isNoInventory,e.playingTime?e.playingTime():null)}else this.cr.fireViewablePixels(l,o.payload(),o.viewabilityStandards(),!!this.o.isNoInventory)},this.updatePlayingTimeForVideo=e=>{var t,i,a;const s=ae();Z=e,null===Z&&delete ie.playingTime;const n=(null===(i=null===(t=null===window||void 0===window?void 0:window.$sf)||void 0===t?void 0:t.ext)||void 0===i?void 0:i.geom)&&window.$sf.ext.geom(),r=null===(a=null==n?void 0:n.self)||void 0===a?void 0:a.iv;if(r&&s.payload&&s.viewabilityStandards){const e=se();this.cr.fireViewablePixelsForVideo(r,s.payload(),s.viewabilityStandards(),!!this.o.isNoInventory,e.playingTime?e.playingTime():null)}},this.requestVideoAutoplay=()=>{this.cms.sendMessage("requestVideoAutoplay")},this.releaseVideoAutoplay=()=>{this.cms.sendMessage("releaseVideoAutoplay")},this.haveVideoAutoplayPermission=()=>{this.cms.sendMessage("haveVideoAutoplayPermission")},this.isOnAmazon=()=>!0,this.sendRelocatedHtmlContentEncodedToAd=e=>{const t=new window.CustomEvent("loadAdWithRelocatedHtmlContent",{detail:{htmlContentEncoded:e}});document.dispatchEvent(t)},this.collapseSlotInternal=()=>{this.logAPIInvocation("collapseSlot"),this.cms.sendMessage("collapseSlot")},this.logError=(e,t,i)=>{this.cms.sendMessage("logError",{message:e,error:t,level:i})},this.collapseSlot=()=>{this.handleFallbackBehavior()},this.handleFallbackBehavior=()=>{this.logAPIInvocation("handleFallbackBehavior"),this.renderFallbackExperience()},this.handleFallbackExperience=()=>{this.cms.sendMessage("handleFallbackExperience")},this.resizeCreativeWrapper=e=>{const t=window.document.getElementById(`ape_${i=this.o,Se(i.slotName)?i.renderingId:i.placementName}_creativeWrapper`);var i;null!==t&&(t.style.height=e.height,t.style.width=e.width)},this.triggerEventInIframe=e=>{window.dispatchEvent(new Event("outerpage"+e.eventType))},this.logAPIInvocation=(e,...t)=>{this.cms.sendMessage("logAPIInvocation",{apiName:e,apiParams:t}),this.cms.sendMessage("logCsaEvent",{metricName:"messenger_"+e})},this.setupComputedAdDetails=e=>{this.o.computed=e.computed},this.cr=new ye(this,i,t)}}class Te{constructor(e,t){this.o=e,this.messagePort=t,this.sendMessage=(e,t)=>{const i={command:e,arid:null==this?void 0:this.o.arid,data:t||{}};try{this.messagePort.postMessage(i)}catch(a){X("Post Message error",a)}}}}class Fe{constructor(e,t,i){this.c=e,this.o=t,this.mL=i,this.pendingMessages=new Map,this.waitForMessageProcessed=async e=>new Promise((t=>this.pendingMessages.set(e,t))),this.receiveMessage=e=>{try{const i=e.data,a=i.command?i.command.split("."):[];let s=this.c[a[0]];for(let e=1;e<a.length&&s;e++)s=s[a[e]];if("customMessage"===i.command){const e=i.data.key,a=i.data.data;if("function"==typeof this.mL[e])try{this.mL[e](a)}catch(t){this.c.logError("Custom Message Listener Error",t)}}else s&&(s(i.data),Le(i.command,this.pendingMessages))}catch(t){return void this.c.logError("Error with "+e.data.command,t)}}}}const Le=(e,t)=>{const i=null==t?void 0:t.get(e);null==i||i(),null==t||t.delete(e)},_e="adfetch:request",De="adfetch:httperror";new Map;var ke=function(){var e;return"function"==typeof(null===(e=null===window||void 0===window?void 0:window.ue)||void 0===e?void 0:e.count)},Re=function(e,t){var i;return null===(i=null===window||void 0===window?void 0:window.ue)||void 0===i?void 0:i.count(e,t)},Ne="adplacements",Ue=function(e){return e.startsWith(Ne)?e:"".concat(Ne,":").concat(e)},He=function(e,t){Be("ERROR",e,t)},Be=function(e,t,i){var a,s;console.error(t,Ve(t,i)),a="safeFrameError",void 0===s&&(s=1),ke()&&Re(Ue(a),s),window.ueLogError&&window.ueLogError(Ve(t,i),{logLevel:e,attribution:"APE-safeframe",message:Oe(t,i)+" | "})},Ve=function(e,t){return t instanceof Error?t:t?new Error(t):new Error(e)},Oe=function(e,t){return t instanceof Error?e+": "+t.message:e},We=new RegExp(/((&#\d{2,4};)|(&[a-z]{2};)|(&[a-z]{3,7};)|(%[a-fA-F0-9]{2})|(\W))pd_rd_plhdr(=|%3D)t((&#\d{2,4};)|(&[a-z]{2,7};)|(%[a-fA-F0-9]{2})|(\W))/),$e="$1",ze="$8",je=function(e,t){var i=t,a=e;if("&pd_rd_plhdr=t"===e||""===e.trim())return i;(a=a.replace(/&amp;/g,"&")).startsWith("&")&&(a=a.replace(/^&+/,"")),a.endsWith("&")&&(a=a.replace(/&+$/,""));try{var s=void 0,n=0;do{if(n++,!(s=i.match(We)))break;var r=s[1],o=s[8],d=s[7],l=r.startsWith("&")&&r.endsWith(";")||o.startsWith("&")&&o.endsWith(";"),c=r.startsWith("%")&&o.startsWith("%")&&"%3D"===d;i=l?i.replace(We,$e+a.replace(/&/g,"&amp;")+ze):c?i.replace(We,$e+encodeURIComponent(a)+ze):i.replace(We,$e+a+ze)}while(s&&n<10)}catch(h){return t}return i},qe="data-val",Ge=function(e,t,i){return function(e){if(""===e)return"";var t=document.getElementById("ape_"+e+"_placement_ClickTracking");return t&&t.hasAttribute(qe)&&t.getAttribute(qe)||""}([e,i,t].join("_"))};const Xe=(e,t,i)=>{try{t.countMetric(x,1),t.logCsaEvent(y),window.setupOMVideoPlayer(e,i),t.countMetric(P,1),t.logCsaEvent(C)}catch(a){t.handleFallbackBehavior()}};class Ke{async getAd(){return{creative:await this.creative(),measurementHtml:this.getMeasurementHtml()}}constructor(e,t,i,s){this.htmlContentEncoded=e,this.htmlContentEncodedLength=t,this.measurementHtmlEncoded=i,this.ilmRelocatedHtmlIsActive=s,this.creative=async()=>{if(this.htmlContentEncoded)return this.decodeHtmlContent(this.htmlContentEncoded);if(this.ilmRelocatedHtmlIsActive)return Promise.resolve(Je());throw new Error("No html content found on a server side fetch")},this.decodeHtmlContent=e=>{const t=this.htmlContentEncodedLength?e:a(e);if(this.htmlContentEncodedLength&&t.length!==this.htmlContentEncodedLength)throw new Error(`Mismatched expected htmlContentEncoded size. Expected ${this.htmlContentEncodedLength} but got ${t.length}`);return t},this.getMeasurementHtml=()=>a(this.measurementHtmlEncoded?this.measurementHtmlEncoded:"")}}const Je=()=>new Promise((e=>document.addEventListener("loadAdWithRelocatedHtmlContent",(async t=>{var i,s;e(a(null!==(s=null===(i=t.detail)||void 0===i?void 0:i.htmlContentEncoded)&&void 0!==s?s:""))}),{once:!0})));class Qe{async getAd(){var e;try{this.sfApi.countMetric(_e,1),this.sfApi.logCsaEvent(r);const t=await be(G(this.aaxUrl));switch(null==t?void 0:t.status){case"ok":return Promise.resolve({creative:t.creative,measurementHtml:null===(e=t.aaxMeasurementTrackers)||void 0===e?void 0:e.html,creativeTemplateName:t.creativeTemplateName,instrumentationPixelUrl:t.instrPixelURL,impressionPixelUrl:t.impPixelURL});case"punt":this.sfApi.countMetric(o,1),this.sfApi.logCsaEvent(o);break;case"error":this.sfApi.countMetric(d,1),this.sfApi.logCsaEvent(d);break;default:this.sfApi.countMetric(l,1),this.sfApi.logCsaEvent(l)}}catch(t){this.sfApi.countMetric(De,1),this.sfApi.logCsaEvent(m),this.sfApi.logError("Couldn't fetch Ad From AAX.",t)}throw new Error("Could not fetch creative html")}constructor(e,t){this.sfApi=e,this.aaxUrl=t}}const Ye=(e,t,i)=>{var a,s;switch(e){case"XSP_CLIENT_SIDE":return new Qe(i,t.src);case"XSP_SERVER_SIDE":return new Ke(t.htmlContentEncoded,t.htmlContentEncodedLength,null!==(a=t.measurementHtmlEncoded)&&void 0!==a?a:"",!!(null===(s=t.expParams)||void 0===s?void 0:s.ilmRelocatedHtmlIsActive));default:throw new Error("Wrong creative flow provided")}},Ze=e=>{if(!("pageType"in e)||!("subPageType"in e)||!("slotName"in e))return"";try{return Ge(e.pageType,e.subPageType,e.slotName)}catch(t){return""}};class et{handleServerSideFetchAd(){var e,t;const i={serverSide:null===(e=this.o)||void 0===e?void 0:e.serverSideFetchAd};let s;if(this.o.htmlContentEncoded){const e=this.o.htmlContentEncodedLength?this.o.htmlContentEncoded:a(this.o.htmlContentEncoded);this.o.htmlContentEncodedLength&&e.length!==this.o.htmlContentEncodedLength&&console.debug(`Mismatched expected htmlContentEncoded size. Expected ${this.o.htmlContentEncodedLength} but got ${e.length}.  This is likely harmless.`);const t=a(this.o.measurementHtmlEncoded?this.o.measurementHtmlEncoded:"");i.htmlContent=e,s=async()=>{await this.loadAd(e,t)}}else{if(!(null===(t=this.o.expParams)||void 0===t?void 0:t.ilmRelocatedHtmlIsActive))throw new Error("No html content found on a server side fetch");s=async()=>{var e;await z(this.loadAd,null!==(e=this.o.measurementHtmlEncoded)&&void 0!==e?e:"")}}return{writeAdHandler:s,adRenderFlowTrace:i}}renderFallbackStaticAdHelper(){}loadAdPlatformSpecific(e){return e}constructor(i,a,s,n,o){this.o=i,this.mp=a,this.mL=s,this.cms=n,this.c=o,this.isLdFired=!1,this.renderCompleteTime=null,this.hasCODFallbackRegistered=!1,this.isDone=!1,this.initSFClient=async()=>{this.ensureGlobals(),j(),window.navigator&&window.navigator.geolocation&&(window.navigator.geolocation.watchPosition=(e,t,i)=>0,window.navigator.geolocation.getCurrentPosition=()=>{}),document.write=this.documentWriteDelegate,document.open=(...e)=>{this.nativeOpen(...e),this.ensureGlobals()},this.mp.onmessage=this.cmr.receiveMessage,this.c.sendLatencyMetric(g),this.cms.sendMessage("safeFrameReady"),await this.cmr.waitForMessageProcessed("setupComputedAdDetails"),this.c.countMetric("adload:iframeinitialized",1),this.c.logCsaEvent("adload_iframeinitialized"),((e,t)=>{t.disableResizeFunc||e.sendMessage("resizeSafeFrameAd"),t.resizePlacementStyle&&e.sendMessage("setResizePlacementStyle")})(this.cms,this.o),window.writeAdHandler=await this.setupWriteAdHandler(),await window.writeAdHandler(),tt(this.mL,this.cms,this.o)},this.setupWriteAdHandler=async()=>{var e,t,i;if(st(this.o))return async()=>this.forceRenderFallbackExperience();if(!Ie().isT1()){const{writeAdHandler:e,adRenderFlowTrace:t}="true"===this.o.serverSideFetchAd?this.handleServerSideFetchAd():this.handleClientSideFetchAd();return this.c.sendAdBarTrace("adRenderFlow",t),e}try{const a="true"===this.o.serverSideFetchAd?"XSP_SERVER_SIDE":"XSP_CLIENT_SIDE",s=await Ye(a,this.o,this.c).getAd();return this.o.htmlContent=s.creative,this.o.measurementHtml=s.measurementHtml,this.o.aaxInstrPixelUrl=null!==(e=s.instrumentationPixelUrl)&&void 0!==e?e:this.o.aaxInstrPixelUrl,this.o.aaxImpPixelUrl=null!==(t=s.impressionPixelUrl)&&void 0!==t?t:this.o.aaxImpPixelUrl,this.o.adCreativeMetaData.adImpressionId=this.o.aaxImpPixelUrl,this.o.adCreativeMetaData.adCreativeTemplateName=null!==(i=s.creativeTemplateName)&&void 0!==i?i:this.o.adCreativeMetaData.adCreativeTemplateName,()=>this.loadAd(s.creative,s.measurementHtml)}catch(a){return this.c.logError("Couldn't getAd from htmlProvider",a),async()=>this.forceRenderFallbackExperience()}},this.handleClientSideFetchAd=()=>{var e;const t={serverSide:null===(e=this.o)||void 0===e?void 0:e.serverSideFetchAd},i=G(this.o.src);t.adSource=i,t.isXsp=!i.includes("x/getad");return{writeAdHandler:async()=>{try{this.c.countMetric(_e,1),this.c.logCsaEvent(r);const e=await be(i);await A(this.c,this.cms,e,this.o,this.loadAd)}catch(e){this.c.countMetric(De,1),this.c.logCsaEvent(m),this.c.logError("AAX fetch error",e),this.c.sendAdBarTrace("aaxCall",{error:"httpError"}),this.c.handleFallbackBehavior()}},adRenderFlowTrace:t}},this.ensureGlobals=()=>{window.onerror=this.handleErrors,window.$sf=te,window.$sfViewableInfo=ae(),window.aaxInstrPixelUrl=this.o.aaxInstrPixelUrl},this.documentWriteDelegate=async e=>{this.hasCODFallbackRegistered||this.o.firePixelsAfter||(this.cms.sendMessage("registerCODFallback",Ee(this.o.aaxImpPixelUrl,$)),this.hasCODFallbackRegistered=!0),await L(e,this,this.c),await this.done(e)},this.addOnLoadListeners=()=>{window.addEventListener("load",(()=>{this.isLdFired||(this.isLdFired=!0,this.c.sendLatencyMetric(f))})),window.addEventListener("load",this.c.fireViewableLatencyMetrics)},this.handleErrors=(e,t,i,a,s)=>{const n=s||new Error(e.toString());return this.c.logError(n.message,n),this.renderCompleteTime||this.forceRenderFallbackExperience(),!0},this.forceRenderFallbackExperience=()=>{Ie().isT1()&&F(this.c,this.o,this.cms);this.o.fallbackStaticAdImgUrl&&this.o.fallbackStaticAdClickUrl?(this.renderFallbackStaticAd(this.o.fallbackStaticAdImgUrl,this.o.fallbackStaticAdClickUrl,this.o.fallbackStaticAdExtraStyle),this.renderCompleteTime=new Date):this.c.collapseSlotInternal(),this.c.handleFallbackExperience()},this.renderFallbackStaticAd=(e,t,i)=>{const a=document.createElement("a");a.target="_top",a.href=t,a.append(((e,t)=>{const i=document.createElement("img");return i.src=e,((e,t)=>{t.split(" ").forEach((t=>{const i=t.split("=");e.setAttribute(i[0],i[1])}))})(i,t),i})(e,i)),document.body.replaceChildren(),document.body.append(a),this.renderFallbackStaticAdHelper(),this.ensureGlobals(),this.mp.onmessage=this.cmr.receiveMessage,this.isDone=!0},this.done=async e=>{const t={};if(this.isDone)t.firstInvocation=!1;else{t.firstInvocation=!0,this.isDone=!0,at(),it();const i=await xe(e);this.cms.sendMessage("startPixelTracking",{isNoInventory:!1,measurementMethod:i}),this.o.adCreativeMetaData&&this.c.cr.fireImageLoaded(this.o.adCreativeMetaData.adCreativeTemplateName),this.c.countMetric("adload:creativewritten",1),this.c.logCsaEvent("adload_creativewritten")}document.addEventListener("touchstart",{handleEvent:()=>{}},!1),this.c.sendAdBarTrace("doneFunction",t)},this.loadAd=async(e,t)=>{var i;if(this.o.isNoInventory=!1,F(this.c,this.o,this.cms),!this.renderCompleteTime){let a=je(null!==(i=Ze(this.o))&&void 0!==i?i:"",e);this.isVideo()?new Pe(window,"ADPT_SF_ADSP_VIDEO_833419").isT1()?Xe(this.o,this.c,a):this.c.handleFallbackBehavior():(t&&(this.c.countMetric("adload:measurementhtml",1),this.c.logCsaEvent("measurementhtml"),a=a.concat(t)),a=this.loadAdPlatformSpecific(a),await this.documentWriteDelegate(a))}},this.isVideo=()=>{return i=this.o.mediaType,a=this.o.adCreativeMetaData.adProgramId,e(i)&&!t.hasOwnProperty(a);var i,a},this.cmr=new Fe(o,i,this.mL),this.nativeWrite=document.write.bind(document),this.nativeOpen=document.open.bind(document),window.onerror=this.handleErrors}}const tt=(e,t,i)=>{e.initAdReporter=e=>{var a;try{window.adReporterConfig=e;const s=document.createElement("script");s.type="text/javascript",s.async=!0,s.src=null!==(a=null==e?void 0:e.adReporterClientUrl)&&void 0!==a?a:"",(document.head||document.body).appendChild(s),t.sendMessage("saveAdDetailsForAdReporter",i)}catch(s){He("Error appending adReporterClient script",s)}}},it=()=>{U("creativeLoad"),window.dispatchEvent(new Event("load"))},at=()=>{U("creativedomcontentloaded"),document.dispatchEvent(new Event("DOMContentLoaded"))},st=e=>!!("true"!==e.abpAcceptable&&e.abpStatus&&e.enableFallbackForAbpStatuses&&e.enableFallbackForAbpStatuses.indexOf(i[e.abpStatus])>-1);class nt extends Ae{constructor(e,t,i,a){super(e,t,i,a),this.isSupported=()=>!0,this.getARID=()=>this.o.arid,this.getDebugInfo=e=>{this.logAPIInvocation("getDebugInfo");const t=ot(this.o.slotName),i={slot:this.o.placementName,slotName:this.o.slotName,shazamId:null==t?void 0:t.shazamId,creativeId:null==t?void 0:t.creativeId,adId:null==t?void 0:t.adId,src:this.o.src,iframeHtml:window.document.body.innerHTML||""};this.customMessage(e.key,i)},this.sendAdInfo=e=>{e&&this.o.adCreativeMetaData&&(this.o.adCreativeMetaData=e)},this.getQueryParam=e=>{this.logAPIInvocation("getQueryParam"),this.countMetric("getqueryparam:"+e,1);let t="";const i=this.o.allowlistedQueryParamKeys?rt(window.location.search,this.o.allowlistedQueryParamKeys):void 0;return i&&(0!==e.indexOf("sf-")&&(t="sf-"+e),t=i[t]||""),t},this.getPlacementInfo=()=>(this.logAPIInvocation("getPlacementInfo"),{slot:this.o.placementName,slotName:this.o.slotName,pageType:this.o.pageType})}}const rt=(e,t)=>{const i=new URLSearchParams(e),a={};return i.forEach(((e,i)=>{t.includes(i)&&(a[i]=e)})),a},ot=e=>{var t;return(null===window||void 0===window?void 0:window.aanResponse)||(window.document.aanResponse?null===(t=window.document)||void 0===t?void 0:t.aanResponse[e+"adData"]:void 0)};class dt extends et{constructor(e,t){const i=new Te(e,t),a={};super(e,t,a,i,new nt(i,e,a,(()=>this.forceRenderFallbackExperience())))}}const lt=async(e,t)=>{var i;try{window.dcmads=window.dcmads||{},window.dcmads.eids="4|40004007";const s=await ct(t);window.renderingWeblabs=s.weblabTreatments,null===(i=null===performance||void 0===performance?void 0:performance.mark)||void 0===i||i.call(performance,"SafeFrame: SF received ad details");const n=e(t,s);try{n.initSFClient()}catch(a){n.c.logError("Could not init SafeFrame Client",a)}}catch(a){X("Could not init ",a)}},ct=async(e,t=3e4)=>{const i=(new Date).getTime();for(;;)try{return await ht(e)}catch(a){if((new Date).getTime()-i>t){const e=`Failed to receive adDetails from host within ${t} ms`,i=new Error(e);throw He(e,i),i}}},ht=async e=>new Promise(((t,i)=>{e.onmessage=e=>{const a=e.data;"adDetails"===a.command?t(a.data):i(`Incorrect message received ${a.command}`)}})),mt=()=>{var e;null===(e=null===performance||void 0===performance?void 0:performance.mark)||void 0===e||e.call(performance,"SafeFrame: Start Send Ready"),window.parent.postMessage("sf iframe ready","*")};var ut;null===(ut=null===performance||void 0===performance?void 0:performance.mark)||void 0===ut||ut.call(performance,"SafeFrame: Enter sf.ts"),window.SFClient||(e=>{const t=i=>{if(i.ports){const a=i.ports[0]?i.ports[0]:i.data;lt(e,a),window.removeEventListener("message",t)}else console.debug("Not a MessagePort message; will continue to wait")};window.addEventListener("message",t),mt()})(((e,t)=>{const i=new dt(t,e);return window.SFClient=i.c,i}))})();
//# sourceMappingURL=sf-1.50.e476b9cf.js.map
